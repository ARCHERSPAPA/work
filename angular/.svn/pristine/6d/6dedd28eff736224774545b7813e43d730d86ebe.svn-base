<div class="new-making">
    <div class="head">
        <div class="head-info">
            <!--<span *ngIf="material && material.versionId" class="ml-8"-->
            <!--[nzTitle]="getCompiledId(material.versionId)"-->
            <!--nzPlacement="topLeft" nz-tooltip>{{getCompiledId(data.versionId)}}</span>-->
            <span *ngIf="materialInfo && materialInfo.submitedMaterialTime"
                class="ml-8">上传时间：{{materialInfo.submitedMaterialTime|date:'yy-MM-dd HH:mm'}}</span>
            <span *ngIf="materialInfo && materialInfo.customConfirmMaterialTime"
                class="ml-8">确认时间：{{materialInfo.customConfirmMaterialTime|date:'yy-MM-dd HH:mm'}}</span>
        </div>
        <div class="head-btn">
            <a href="javascript:void(0)" (click)="bubbleModalByCombo()" *ngIf="showBtnByState()">添加套餐</a>
            <a href="javascript:void(0)" (click)="bubbleModalByBranch()" *ngIf="showBtnByState()">添加单品</a>
        </div>
    </div>
    <div class="head-making-list">

        <nz-table #sinTable [nzData]="material.infoMaps" [nzShowPagination]="false" nzSize="small" [nzNoResult]="' '"
            nzBordered='true' [nzScroll]="{y:'600px'}">

            <thead>
                <th colspan="12"
                    style="text-align: center;line-height: 45px;border-bottom:1px solid #e8e8e8;background-color: rgb(250,250,250);">
                    大项名称
                </th>
                <th nzRight="0px" [rowSpan]="2" style="vertical-align:middle; border:1px solid #e8e8e8;  border-top: none; min-width: 180px;max-width:180px;background-color: rgb(250,250,250);
                padding-left: 10px;" *ngIf="showBtnByState()">操作
                </th>
                <tr>
                    <th>品牌</th>
                    <th>名称</th>
                    <th>类型</th>
                    <th>规格</th>
                    <th>型号</th>
                    <th>材质</th>
                    <th>颜色</th>
                    <th>单位</th>
                    <th>产地</th>
                    <!--<th>单价</th>-->
                    <th width="10%">数量</th>
                    <!--<th>合计</th>-->
                    <th>说明</th>
                    <th>备注</th>
                </tr>
            </thead>
            <tbody>
                <ng-template ngFor let-data let-id="index" [ngForOf]="material.infoMaps" let-t="index">

                    <td >
                        <div style="margin-top: 10px;" *ngIf='data.infos.length>pageSize'>
                            <nz-pagination [nzPageIndex]="data.pageNo" [nzTotal]="data.infos.length"
                                style="position:absolute;" [nzPageSize]="pageSize" [nzShowTotal]="totalTemplate"
                                [nzSize]="'small'" [nzHideOnSinglePage]="true"
                                (nzPageIndexChange)="pageChange($event,data)">
                            </nz-pagination>
                        </div>
                    </td>
                    <td [colSpan]="11" align="center" *ngIf='data.infos && !data.planId && data.infos.length>0'
                        class='categoryName'>
                        {{data.categoryName}}
                    </td>
                    <td [colSpan]="11" align="center" *ngIf='data.infos && data.planId ' class='categoryName comboName'>
                        <div class="commBo">
                            <div>
                                套餐：{{data.infos[0].planName}}<span
                                    *ngIf="data.infos[0].versionDetail">（{{renderversionDetail(data.infos[0].versionDetail)}}）</span>，材料商：{{data.infos[0].supplierName}}<span *ngIf="data.separable==0">
                                        ， 数量：{{data.infos[0].planNum}}{{data.infos[0] && data.infos[0].planUnit?data.infos[0].planUnit:''}}
                                    </span> 
                                <span *ngIf="data.infos[0].planExplainMsg" [nzTitle]="data.infos[0].planExplainMsg"
                                    nzPlacement="top" nz-tooltip>
                                    <i nz-icon type="info-circle" theme="outline"></i>
                                </span>
                                <span *ngIf="data.infos[0].planRemark && data.separable==0" [nzTitle]="data.infos[0].planRemark"
                                    nzPlacement="top" nz-tooltip>
                                    <i nz-icon type="question-circle" theme="outline"></i>
                                </span>
                            </div>

                            <div class="commBo-btn" *ngIf="showBtnByState()">
                                <a href="javascript:void(0)" class="ml-8" title="修改数量" (click)="editNum(data)" *ngIf="data.separable==0">修改数量</a>
                                <a href="javascript:void(0)" class="ml-8" title="备注" (click)="editRemark(data)"
                                *ngIf="data.separable==0"
                                >备注</a>
                                <a href="javascript:void(0)" class="ml-8" title="删除套餐" nz-popconfirm nzTitle="确定删除该套餐吗?"
                                    nzOkText="确定" nzCancelText="
                   取消" (nzOnConfirm)="delCombo(t)">删除套餐</a>
                            </div>
                        </div>


                    </td>
                    <ng-template ngFor let-inner let-i="index" let-last="last" [ngForOf]="computedBranchInfos(data)">
                        <tr>
                            <td [title]="inner.brand?inner.brand:''">{{inner.brand?inner.brand:'--'}}
                            </td>
                            <td [title]="inner.name?inner.name:(inner.projectName?inner.projectName:'')">
                                {{inner.name?inner.name:(inner.projectName?inner.projectName:'--')}}
                            </td>
                            <td [title]="inner.category?inner.category:''">
                                {{inner.category?inner.category:'--'}}
                            </td>
                            <td [title]="inner.spec?inner.spec:''">
                                {{inner.spec?inner.spec:'--'}}
                            </td>
                            <td [title]="inner.model?inner.model:''">{{inner.model?inner.model:'--'}}
                            </td>
                            <td [title]="inner.material?inner.material:''">
                                {{inner.material?inner.material:'--'}}
                            </td>
                            <td *ngIf="inner.color && inner.color.length > 0" [title]="inner.color">
                                {{inner.color}}
                            </td>
                            <td *ngIf="!inner.color">--</td>
                            <td [title]="inner.sellingUnit?inner.sellingUnit:(inner.unit?inner.unit:0)"
                                *ngIf=" !data.planId">
                                {{inner.sellingUnit?inner.sellingUnit:(inner.unit?inner.unit:'--')}}
                            </td>
                            <td [title]="inner.unit?inner.unit:'--'" *ngIf=" data.planId">
                                {{inner.unit?inner.unit:'--'}}
                            </td>
                            <td [title]="inner.origin?inner.origin:'--'">{{inner.origin?inner.origin:'--'}}</td>
                            <!--<td [title]="inner.univalent?inner.univalent:0">-->
                            <!--{{(inner.univalent?inner.univalent:0)|number:'1.2'}}-->
                            <!--</td>-->
                            <td [title]="inner.num?inner.num:0" width="10%">
                                <input nz-input [num]="inner.number" [formula]="inner.formula" [disabled]='!showBtnByState()' *ngIf=" data.separable==1"
                                [infoId]="inner.id" [id]="cid" role="10" tabindex="{{10000+(t+1)*100+i}}"
                                (changeValue)="changeValue($event,inner)" revInputDecimal
                                value="{{inner.formula?(inner.formula+'='+inner.number):inner.number}}" />
                                <input nz-input [num]="inner.num" [formula]="inner.formula" *ngIf=" !data.planId" [disabled]='!showBtnByState()'
                                    [infoId]="inner.id" [id]="cid" role="10" tabindex="{{10000+(t+1)*100+i}}"
                                    (changeValue)="changeValue($event,inner)" revInputDecimal
                                    value="{{inner.formula?(inner.formula+'='+inner.num):inner.num}}" />
                                <span *ngIf="data.separable==0 && data.planId">{{inner.num?inner.num:'--'}}</span>
                            </td>
                            <td [nzTitle]="inner.offerExplain?inner.offerExplain:'暂无说明信息'" nzPlacement="topLeft"
                                nz-tooltip>{{inner.offerExplain?inner.offerExplain:'--'}}
                                <a href="javascript:void(0)"></a></td>
                            <td [nzTitle]="inner.remark?inner.remark:'暂无备注信息'" *ngIf=" !data.planId ||  data.separable==1"
                                nzPlacement="topLeft" nz-tooltip>
                                {{inner.remark?inner.remark:'--'}}
                            </td>
                            <td *ngIf=" data.planId && data.separable==0">--</td>
                            <td *ngIf="showBtnByState() && data.planId && data.separable==0" style="min-width:180px;max-width:180px;">--</td>
                            <td *ngIf="showBtnByState() && data.planId && data.separable==1" style="min-width:180px;max-width:180px;">  
                                <a nz-dropdown href="javascript:void(0)"(click)="remarkItem(inner)"> 备注</a>
                                <a href="javascript:void(0)" nz-popconfirm nzTitle="确定删除该项吗?" nzOkText="确定"
                                nzCancelText="

               取消" (nzOnConfirm)="delItem(i+ (data.pageNo-1)*pageSize,t)">删除</a>
                            <td *ngIf="showBtnByState() && !data.planId" style="min-width:180px;max-width:180px;">
                                <nz-dropdown>
                                    <a nz-dropdown href="javascript:void(0)">更多<i nz-icon type="down"></i></a>
                                    <ul nz-menu>
                                        <li nz-menu-item (click)="remarkItem(inner)">备注</li>
                                        <li nz-menu-item
                                            (click)="copyItem($event,inner,1,i+ (data.pageNo-1)*pageSize,t)">复制
                                        </li>
                                    </ul>
                                </nz-dropdown>


                                <a href="javascript:void(0)" class="ml-8" title="上移"
                                    *ngIf="showUp(data,i+ (data.pageNo-1)*pageSize) "
                                    (click)="moveItemUp(data,i+ (data.pageNo-1)*pageSize)"><i nz-icon
                                        type="arrow-up"></i></a>
                                <a href="javascript:void(0)" class="ml-8" title="下移"
                                    *ngIf="showDown(data,i+ (data.pageNo-1)*pageSize) "
                                    (click)="moveItemDown(data,i+ (data.pageNo-1)*pageSize)"><i nz-icon
                                        type="arrow-down"></i></a>
                                <a href="javascript:void(0)" class="ml-8" title="置顶"
                                    *ngIf="showTop(data,i+ (data.pageNo-1)*pageSize)"
                                    (click)="moveItemTop(data,i+ (data.pageNo-1)*pageSize)"><i nz-icon
                                        type="to-top"></i></a>

                                <a href="javascript:void(0)" nz-popconfirm nzTitle="确定删除该项吗?" nzOkText="确定"
                                    nzCancelText="

                   取消" (nzOnConfirm)="delItem(i+ (data.pageNo-1)*pageSize,t)"><i nz-icon style="color: red;"
                                        type="delete"></i></a>
                            </td>
                        </tr>
                    </ng-template>

                </ng-template>
            </tbody>

        </nz-table>
        <p *ngIf='material.infoMaps && material.infoMaps.length==0'>暂无数据</p>
    </div>
</div>

<ng-template #totalTemplate let-total>总条数：{{ total }}</ng-template>
<div nz-row class="btns-fixed">
    <div nz-col class="text-right">
        <a class="ant-btn mr-16" target="_blank"
            *ngIf="material && material['infoMaps'] && material['infoMaps'].length > 0"
            [routerLink]="['/view/material']" [queryParams]="{cid:btoa(cid),type:5,isNewQuote:isNewQuote}"
            [title]="'只能预览已保存的数据信息'">预览</a>
        <!--<button nz-button nzType="primary" *ngIf="showBtnByState()"-->
        <!--(click)="doMaterial($event)" [disabled]="materialListener()">保存-->
        <!--</button>-->
        <button nz-button nzType="primary" *ngIf="showBtnByState()" class="ml-8" (click)="saveMaterial($event)">保存
        </button>
    </div>
</div>


<!---添加备注--->
<nz-modal [(nzVisible)]="markVisible" nzTitle="备注" nzOkText="确定" nzCancelText="取消" (nzOnCancel)="markCancel()"
    (nzOnOk)="markOk()">
    <div class="modify">
        <form nz-form [formGroup]="markForm">
            <nz-form-item>
                <nz-form-label [nzSpan]="5">备注</nz-form-label>
                <nz-form-control [nzSpan]="16" class="textarea">
                    <textarea nz-input type="text" placeholder="请输入备注信息" autocomplete="off" rows="5"
                        [(ngModel)]="markInfo" formControlName="markInfo" name="markInfo" maxlength="500"></textarea>
                    <span *ngIf="markInfo && markInfo.length > 0"
                        class="count"><span>{{markInfo.length}}</span>/500</span>
                </nz-form-control>
            </nz-form-item>
        </form>
    </div>
</nz-modal>

<!---添加数量--->
<nz-modal [(nzVisible)]="numVisible" nzTitle="数量" nzOkText="确定" nzCancelText="取消" (nzOnCancel)="numCancel()"
    (nzOnOk)="numOk()">
    <div class="modify">
        <form nz-form [formGroup]="markForm">
            <nz-form-item>
                <nz-form-label [nzSpan]="5">数量</nz-form-label>
                <nz-form-control [nzSpan]="16" class="textarea">
                    <nz-input-number style="width: 100%;" [(ngModel)]="comboNum" formControlName="comboNum"
                        name="comboNum"></nz-input-number>
                </nz-form-control>
            </nz-form-item>
        </form>
    </div>
</nz-modal>
<!---添加大项--->

